#!/usr/bin/env bash
set -euo pipefail

palette_file="${1:-$HOME/.dotfiles/.config/theme/palette.json}"

generator="$HOME/.dotfiles/.config/theme/scripts/generate_theme.py"
if [[ ! -f "$generator" ]]; then
  echo "ERROR: generator not found: $generator" >&2
  exit 1
fi

python3 "$generator" "$palette_file"

if command -v tmux >/dev/null 2>&1; then
  if tmux list-sessions >/dev/null 2>&1; then
    tmux source-file "$HOME/.tmux.conf"
    echo "tmux config reloaded"
  else
    echo "tmux server not running; generated theme file only"
  fi
fi

if command -v waybar >/dev/null 2>&1; then
  if pgrep -x waybar >/dev/null 2>&1; then
    pkill waybar
    waybar >/dev/null 2>&1 &
    echo "waybar restarted"
  else
    echo "waybar not running; generated colors only"
  fi
fi

if command -v hyprctl >/dev/null 2>&1; then
  if [ -n "${HYPRLAND_INSTANCE_SIGNATURE:-}" ]; then
    if hyprctl reload config-only >/dev/null 2>&1; then
      echo "hyprland config reloaded"
    else
      echo "hyprland reload failed; generated colors only"
    fi
  else
    echo "hyprland not running in this shell; generated colors only"
  fi
fi

if command -v hyprpaper >/dev/null 2>&1; then
  if pgrep -x hyprpaper >/dev/null 2>&1; then
    pkill hyprpaper
    hyprpaper >/dev/null 2>&1 &
    echo "hyprpaper restarted"
  else
    echo "hyprpaper not running; generated wallpaper only"
  fi
fi

#!/usr/bin/env python3
from __future__ import annotations

import argparse
import json
import shutil
import subprocess
import sys
from pathlib import Path


def _paths() -> tuple[Path, Path, Path, Path]:
    home = Path.home()
    theme_dir = home / ".dotfiles/.config/theme"
    palette_dir = theme_dir / "palettes"
    active = theme_dir / "palette.json"
    backup = theme_dir / "palette.last.json"
    apply_cmd = home / ".dotfiles/bin/theme-apply"
    return palette_dir, active, backup, apply_cmd


def list_palettes(palette_dir: Path) -> int:
    names = sorted(p.stem for p in palette_dir.glob("*.json"))
    if not names:
        print("No palettes found.", file=sys.stderr)
        return 1
    for name in names:
        print(name)
    return 0


def show_current(active: Path) -> int:
    print(str(active))
    if not active.exists():
        print("Active palette file missing.", file=sys.stderr)
        return 1
    try:
        data = json.loads(active.read_text(encoding="utf-8"))
    except json.JSONDecodeError as err:
        print(f"Invalid JSON in active palette: {err}", file=sys.stderr)
        return 1
    print(json.dumps(data, indent=2))
    return 0


def run_apply(apply_cmd: Path) -> int:
    if not apply_cmd.exists():
        print(f"theme-apply not found: {apply_cmd}", file=sys.stderr)
        return 1
    proc = subprocess.run([str(apply_cmd)], check=False)
    return proc.returncode


def restore_palette(backup: Path, active: Path, apply_cmd: Path) -> int:
    if not backup.exists():
        print(f"No backup palette found: {backup}", file=sys.stderr)
        return 1
    shutil.copy2(backup, active)
    rc = run_apply(apply_cmd)
    if rc == 0:
        print(f"Restored previous palette from {backup}")
    return rc


def switch_palette(name: str, palette_dir: Path, active: Path, backup: Path, apply_cmd: Path) -> int:
    candidate = palette_dir / f"{name}.json"
    if not candidate.exists():
        print(f"Palette not found: {name}", file=sys.stderr)
        print("Available palettes:", file=sys.stderr)
        for n in sorted(p.stem for p in palette_dir.glob("*.json")):
            print(f"  {n}", file=sys.stderr)
        return 1

    if active.exists():
        shutil.copy2(active, backup)

    shutil.copy2(candidate, active)
    rc = run_apply(apply_cmd)
    if rc == 0:
        print(f"Switched to palette: {name}")
    return rc


def main() -> int:
    parser = argparse.ArgumentParser(
        prog="theme-switch",
        description="Switch seasonal theme palettes and apply generated configs.",
    )
    group = parser.add_mutually_exclusive_group(required=True)
    group.add_argument("palette", nargs="?", help="Palette name to activate")
    group.add_argument("--list", action="store_true", help="List available palettes")
    group.add_argument("--current", action="store_true", help="Show active palette path and JSON")
    group.add_argument("--restore", action="store_true", help="Restore previous palette backup")

    args = parser.parse_args()
    palette_dir, active, backup, apply_cmd = _paths()

    if args.list:
        return list_palettes(palette_dir)
    if args.current:
        return show_current(active)
    if args.restore:
        return restore_palette(backup, active, apply_cmd)
    if args.palette:
        return switch_palette(args.palette, palette_dir, active, backup, apply_cmd)

    return 2


if __name__ == "__main__":
    raise SystemExit(main())
